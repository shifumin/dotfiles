# CLAUDE.md

> **⚠️ chezmoi管理**: 編集は `~/.local/share/chezmoi/dot_claude/CLAUDE.md` で行い `chezmoi apply` で適用。
>
> **優先度**: グローバル設定 < プロジェクト固有CLAUDE.md

---

## 🔴 重要な原則（必須遵守）

以下の7原則は**例外なく遵守**すること:

| # | 原則 | 説明 | 違反時のリスク |
|---|------|------|---------------|
| 1 | **既存のコードスタイルを厳守** | プロジェクトの規約から逸脱しない | 一貫性の破壊、レビュー負担増 |
| 2 | **プロジェクトのツールを使用** | 新しいツールやフレームワークを勝手に導入しない | 依存関係の肥大化 |
| 3 | **コミット前の必須チェック** | リンターとテストを必ず実行する | CIでの失敗 |
| 4 | **テストの同期** | 実装を追加・変更したら、対応するテストも追加・変更 | テストカバレッジ低下 |
| 5 | **ドキュメントの同期** | 実装を追加・変更したら、CLAUDE.md・README.mdも更新 | ドキュメント陳腐化 |
| 6 | **疑問があれば必ず質問** | 要件・仕様・設計判断に迷ったら、作業を中断してユーザーに確認 | 手戻り発生 |
| 7 | **スキル優先使用** | MCPツールより先にスキルを確認・使用する（詳細は「ツール選択ルール」参照） | 認証エラー、非効率な操作 |

### 原則4・5の判断基準

| 変更内容 | テスト更新 | ドキュメント更新 |
|----------|-----------|-----------------|
| 新機能追加 | ✅ 必須 | ✅ 必須 |
| バグ修正 | ✅ 回帰テスト追加 | 🟡 影響があれば |
| リファクタリング | ✅ 既存テストが通ること確認 | 🟡 API変更時のみ |
| 設定変更のみ | ❌ 不要 | ✅ 必須 |

---

## 入出力ルール

| カテゴリ | ルール |
|----------|--------|
| ユーザー入力 | `y` / `yes` / `ok` → 「はい」として処理続行 |
| 日本語出力 | 造語禁止、不自然な翻訳は英単語を使用 |

---

## コード品質

### テスト作成ルール

| 観点 | ルール |
|------|--------|
| カバレッジ | 正常系・異常系・エッジケースを網羅 |
| テスト対象 | publicインターフェースのみ（privateメソッドは対象外） |

**理由**: 内部実装への依存を避け、リファクタリング耐性を高めるため

### YARDコメント（Rubyのみ）

Rubyコード実装時、publicメソッドにYARDコメントを追記: `@param`, `@return`, `@raise`

**理由**: AIとIDEがコードを正確に理解するため

---

## ドキュメント作成

### 基本方針

| 方針 | 説明 |
|------|------|
| シンプルさ優先 | 冗長な表現を削る |
| 自明な内容は省略 | 文脈から推測可能な説明は不要 |
| 曖昧さを排除 | 条件・理由・例外を明確に |

### フォーマット

| ルール | 説明 |
|--------|------|
| 見出し階層 | `#` → `##` → `###` の順 |
| 箇条書き | `-` に統一 |
| 比較情報 | テーブル化 |
| 理由の明示 | 指示には「なぜ」を1文追加 |

---

## ツールの制限事項

| ツール | 制限 | 回避策 |
|--------|------|--------|
| **Writeツール** | 行末スペースを自動削除 | `cat >| file << 'EOF'` を使用（Markdown改行保持時）|

---

## Git

### コミットメッセージ

| ルール | 説明 |
|--------|------|
| **英語で記述** | `feat: add user search` 形式 |
| **Conventional Commits** | `feat`, `fix`, `refactor`, `docs`, `test`, `chore` |

### コミット前チェック（必須）

`git diff --staged` で以下が含まれていないか確認:

| 種類 | 例 | 検出パターン |
|------|-----|-------------|
| 認証情報 | APIキー、トークン、パスワード | `api_key`, `token`, `password` |
| 個人情報 | 公開を意図しないメール、電話番号 | `@gmail.com`, 電話番号形式 |
| インフラ情報 | 内部URL、秘密鍵、証明書 | `.pem`, `-----BEGIN` |
| 環境情報 | 本番環境の接続文字列、ホスト名 | `production`, `DATABASE_URL` |

**秘匿情報を検出した場合**: 即座にユーザーに報告し、コミットを中止する。

---

## シェルコマンド

### mise exec 必須コマンド

以下は必ず `mise exec --` 経由で実行:

| カテゴリ | コマンド |
|----------|----------|
| Ruby | `bundle`, `rails`, `rspec`, `ruby` |
| Node.js | `pnpm`, `node`, `npm` |

**理由**: miseで管理されている環境変数を正しく読み込むため

### chezmoi

> **🔴 重要**: chezmoi管理下のファイルは**直接編集禁止**

| 対象パス | ソースディレクトリ |
|----------|-------------------|
| `~/.claude/*` | `~/.local/share/chezmoi/dot_claude/` |
| `~/.config/*` | `~/.local/share/chezmoi/dot_config/` |
| `~/.zshrc` 等 | `~/.local/share/chezmoi/dot_zshrc` 等 |

**編集手順**:
1. ソースディレクトリのファイルを編集
2. `chezmoi diff` で差分確認
3. `chezmoi apply` で適用

| 状況 | 対応 |
|------|------|
| `chezmoi apply` 成功 | そのまま続行 |
| エラー発生（競合など） | ユーザーに報告し対応を確認（`--force` 禁止） |

**理由**: 直接編集するとソースとターゲットの不整合が発生する

---

## カスタムコマンド

`~/.claude/commands/` に定義。`/コマンド名` で実行。コマンド一覧は各ファイルを参照。

---

## ツール選択ルール

**処理フロー**: リクエスト受信 → スキル該当確認 → 該当すればスキル使用 → 該当しなければ他ツール

### スキル優先マッピング

| トリガーキーワード | 使用するスキル | 禁止するMCPツール |
|-------------------|---------------|------------------|
| 予定、カレンダー、スケジュール | `/google-calendar` | `mcp__google-calendar__*` |
| PR、Issue、GitHub | `/github` | - |
| メール、Gmail、受信、送信者 | `/gmail` | - |

### 判定ロジック

```
IF リクエストに「予定」「カレンダー」「スケジュール」を含む:
  USE Skill(google-calendar)
  DO NOT USE mcp__google-calendar__* ツール

IF リクエストに「PR」「Issue」「GitHub」を含む:
  USE Skill(github)

IF リクエストに「メール」「Gmail」「受信」「送信者」を含む:
  USE Skill(gmail)
```

スキル定義: `~/.claude/skills/`

### Notion連携

Notionリンク（`https://www.notion.so/...`）のリンク先情報が必要な場合、Notion MCPを使用する。

| 操作 | ツール | 用途 |
|------|--------|------|
| ページ取得 | `mcp__notion__API-retrieve-a-page` | プロパティ取得 |
| 内容取得 | `mcp__notion__API-get-block-children` | ページ本文取得 |
| 検索 | `mcp__notion__API-post-search` | タイトルで検索 |

**ページIDの抽出**: URLの末尾32文字（ハイフンなし）をUUID形式に変換
- 例: `https://www.notion.so/WF-1000XM4-6199211160cd4d0d9211311a3229c58b`
  → ページID: `61992111-60cd-4d0d-9211-311a3229c58b`

---

## プロジェクト固有の設定

各プロジェクトのCLAUDE.mdで定義。
