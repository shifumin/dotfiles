# CLAUDE.md

> **⚠️ chezmoi管理**: 編集は `~/.local/share/chezmoi/dot_claude/CLAUDE.md` で行い `chezmoi apply` で適用。
>
> **優先度**: グローバル設定 < プロジェクト固有CLAUDE.md

---

## 🔴 重要な原則（必須遵守）

以下の6原則は**例外なく遵守**すること:

| # | 原則 | 説明 | 違反時のリスク |
|---|------|------|---------------|
| 1 | **既存のコードスタイルを厳守** | プロジェクトの規約から逸脱しない | 一貫性の破壊、レビュー負担増 |
| 2 | **プロジェクトのツールを使用** | 新しいツールやフレームワークを勝手に導入しない | 依存関係の肥大化 |
| 3 | **コミット前の必須チェック** | リンターとテストを必ず実行する | CIでの失敗 |
| 4 | **テストの同期** | 実装を追加・変更したら、対応するテストも追加・変更 | テストカバレッジ低下 |
| 5 | **ドキュメントの同期** | 実装を追加・変更したら、CLAUDE.md・README.mdも更新 | ドキュメント陳腐化 |
| 6 | **疑問があれば必ず質問** | 要件・仕様・設計判断に迷ったら、作業を中断してユーザーに確認 | 手戻り発生 |

### 原則4・5の判断基準

| 変更内容 | テスト更新 | ドキュメント更新 |
|----------|-----------|-----------------|
| 新機能追加 | ✅ 必須 | ✅ 必須 |
| バグ修正 | ✅ 回帰テスト追加 | 🟡 影響があれば |
| リファクタリング | ✅ 既存テストが通ること確認 | 🟡 API変更時のみ |
| 設定変更のみ | ❌ 不要 | ✅ 必須 |

---

## ユーザーとのインタラクション

| 入力 | 解釈 |
|------|------|
| `y` / `yes` / `ok` | 「はい」「了承」として処理を続行 |

---

## 文章スタイル

### 日本語表現のルール

| ルール | 説明 |
|--------|------|
| **造語禁止** | 一般的な用語、広く使われる日本語を使うこと |
| **不自然な翻訳禁止** | 不自然な日本語になりそうな場合は元の英単語を使うこと |

**理由**: 読みやすさと正確性を確保するため

---

## コード品質

### テスト作成ルール

| 観点 | ルール |
|------|--------|
| カバレッジ | 正常系・異常系・エッジケースを網羅 |
| テスト対象 | publicインターフェースのみ（privateメソッドは対象外） |

**理由**: 内部実装への依存を避け、リファクタリング耐性を高めるため

### YARDコメント（Rubyのみ）

Rubyコード実装時は以下の要素にYARDコメントを追記:
- クラス/モジュールの概要
- publicメソッドの説明
- パラメータ（`@param`）
- 戻り値（`@return`）
- 例外（`@raise`）

**理由**: AIとIDEがコードを正確に理解するため

```ruby
# ユーザーを検索する
#
# @param name [String] 検索するユーザー名
# @param limit [Integer] 取得件数の上限（デフォルト: 10）
# @return [Array<User>] マッチしたユーザーの配列
# @raise [ArgumentError] nameが空の場合
def find_users(name, limit: 10)
  # ...
end
```

---

## ツールの制限事項

| ツール | 制限 | 回避策 |
|--------|------|--------|
| **Writeツール** | 行末スペースを自動削除する | Bashリダイレクト（`cat >| file << 'EOF'`）を使用 |

**適用シーン**: Markdownで行末スペース2つによる改行（`<br>`相当）が必要な場合

```bash
# ✅ OK: 行末スペースを保持
cat >| /path/to/file.md << 'EOF'
行末スペース2つで改行
次の行
EOF

# ❌ NG: Writeツール（行末スペースが消える）
```

---

## Git

### コミットメッセージ

| ルール | 説明 |
|--------|------|
| **英語で記述** | `feat: add user search` 形式 |
| **Conventional Commits** | `feat`, `fix`, `refactor`, `docs`, `test`, `chore` |

### コミット前チェック（必須）

`git diff --staged` で以下が含まれていないか確認:

| 種類 | 例 | 検出パターン |
|------|-----|-------------|
| 認証情報 | APIキー、トークン、パスワード | `api_key`, `token`, `password` |
| 個人情報 | 公開を意図しないメール、電話番号 | `@gmail.com`, 電話番号形式 |
| インフラ情報 | 内部URL、秘密鍵、証明書 | `.pem`, `-----BEGIN` |
| 環境情報 | 本番環境の接続文字列、ホスト名 | `production`, `DATABASE_URL` |

**秘匿情報を検出した場合**: 即座にユーザーに報告し、コミットを中止する。

---

## シェルコマンド

### mise exec 必須コマンド

以下のコマンドは必ず `mise exec --` 経由で実行すること:

| カテゴリ | コマンド |
|----------|----------|
| Ruby | `bundle`, `rails`, `rspec`, `ruby` |
| Node.js | `pnpm`, `node`, `npm` |

**理由**: miseで管理されているツールと環境変数（`.mise.toml`）を正しく読み込むため

```bash
# ✅ OK: mise exec経由
mise exec -- bundle exec rspec spec/models/post_spec.rb
mise exec -- pnpm install
mise exec -- rails console

# ❌ NG: 直接実行（環境変数が読み込まれない可能性）
bundle exec rspec spec/models/post_spec.rb
```

### chezmoi

| 状況 | 対応 |
|------|------|
| `chezmoi apply` 成功 | そのまま続行 |
| エラー発生（競合など） | ユーザーに報告し対応を確認（`--force` 禁止） |

---

## カスタムコマンド

`~/.claude/commands/` に定義されたスラッシュコマンド。`/コマンド名` で実行。

### ワークフロー

| コマンド | 説明 |
|----------|------|
| `/finish` | 作業完了時: リンター・テスト実行 + ドキュメント更新 |
| `/push` | 適切な粒度でcommit/push |

### コード品質

| コマンド | 説明 |
|----------|------|
| `/rubocop` | Rubyリンター実行 |
| `/check-srp` | 単一責任の原則違反をチェック |
| `/check-performance` | パフォーマンス改善点をチェック |
| `/update-test` | テストを調整 |

### ドキュメント

| コマンド | 説明 |
|----------|------|
| `/update-document` | CLAUDE.md/README.mdを更新 |
| `/update-claude-md` | CLAUDE.mdに内容を追加 |
| `/optimize-for-ai` | ドキュメントをAI向けに最適化 |

### GitHub

| コマンド | 説明 |
|----------|------|
| `/create-github-repo` | GitHubリポジトリを作成 |
| `/review-pr` | PRをレビュー |
| `/review-pr-comment` | PRコメントを確認 |

### その他

| コマンド | 説明 |
|----------|------|
| `/multi-llm-search` | 複数LLMで同時検索 |
| `/notebooklm-upload` | NotebookLMに音声概要を作成 |

---

## スキル

`~/.claude/skills/` に定義されたスキル。自然言語または `/スキル名` で実行。

> **🔴 重要**: MCPツールではなく、スキルを使用すること
>
> **理由**: スキルはユーザーの使用パターンに最適化されている

| スキル | 説明 | 呼び出し例 |
|--------|------|-----------|
| `/google-calendar` | 予定の取得・作成・更新・削除 | 「今日の予定」「明日ミーティング入れて」 |
| `/github` | PR・Issue操作（ghコマンド使用） | 「PRを見て」「Issueを作成」 |

---

## プロジェクト固有の設定

このセクションは各プロジェクトのCLAUDE.mdで定義。グローバル設定では空。

<!-- プロジェクト固有の設定をここに追加 -->
