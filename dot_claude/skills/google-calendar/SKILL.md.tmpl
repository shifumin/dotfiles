---
description: Googleカレンダーの予定を取得・作成・更新・削除する。
「今日の予定」「明日のスケジュール」「予定を教えて」「予定を作成」
「カレンダーに追加」「予定を変更」「予定を削除」などのリクエストで使用。
---

# Googleカレンダー操作

ユーザーがカレンダーの予定に関する操作をリクエストした場合、Rubyスクリプトを使用して処理する。

## 操作の判定

| 操作 | トリガーとなる表現例 | 使用スクリプト |
|------|---------------------|---------------|
| 取得 | 「今日の予定」「明日のスケジュール」「予定を教えて」 | google_calendar_fetcher.rb |
| 作成 | 「予定を作成」「〜を登録」「カレンダーに追加」「〜入れて」 | google_calendar_creator.rb |
| 更新 | 「予定を変更」「時間を〜に変更」「〜を更新」「移動して」 | google_calendar_updater.rb |
| 削除 | 「予定を削除」「〜をキャンセル」「予定を消して」 | google_calendar_deleter.rb |

---

## 共通設定

### スクリプトパスと実行方法

すべてのスクリプトは以下のディレクトリに配置:
`~/ghq/github.com/shifumin/google-calendar-tools-ruby/`

実行時は必ず`mise exec`を使用:
```bash
mise exec --cd ~/ghq/github.com/shifumin/google-calendar-tools-ruby -- ruby <script_name>.rb [options]
```

### カレンダー設定

| カレンダー名 | カレンダーID | 表記 |
|-------------|-------------|------|
| 私用（デフォルト） | {{ .calendar.personal_email }} | 【私用】 |
| しふみん | {{ .calendar.shifumin_calendar_id }} | 【しふみん】 |
| 仕事 | {{ .calendar.work_email }} | 【仕事】 |

### 日付の解釈ルール

- **相対表現**: 今日/明日/明後日/昨日/来週月曜 などを絶対日付に変換
- **絶対表現**: 12/5, 2025-01-15, YYYY-MM-DD などをそのまま使用
- **時刻のみ**: 今日の日付を補完
- **タイムゾーン**: Asia/Tokyo
- **ISO8601形式**: 例: 2025-12-01T19:00:00

---

## 操作1: 予定取得

### 引数

| 引数 | 説明 | Rubyスクリプトへの渡し方 |
|------|------|-------------------------|
| 引数なし | 今日の予定 | 引数なし |
| 明日 | 明日の予定 | `tomorrow` |
| 明後日 | 明後日の予定 | 日付計算してYYYY-MM-DD形式 |
| YYYY-MM-DD | 指定日の予定 | そのまま |

### 実行コマンド

```bash
mise exec --cd ~/ghq/github.com/shifumin/google-calendar-tools-ruby -- ruby google_calendar_fetcher.rb [date_arg]
```

### 出力の整形

1. **除外**: `event_type`が`workingLocation`の予定
2. **時刻フォーマット**:
   - 終日予定（`start.date`あり）: `[終日]`
   - 時間指定（`start.date_time`あり）: `HH:MM-HH:MM`形式
3. **複数日にまたがる予定**:
   - 前日から継続: 00:00を開始時刻として表示
   - 翌日以降に終了: 23:59を終了時刻として表示
4. **並び順**: 終日予定を先頭、その後時間指定予定を開始時刻昇順
5. **カレンダー名**: IDに応じて【仕事】【しふみん】【私用】を付与

### 出力形式

```markdown
## YYYY-MM-DD の予定

- [終日] 予定名【カレンダー名】
- HH:MM-HH:MM 予定名【カレンダー名】
```

予定が0件の場合: 「予定はありません」と表示

---

## 操作2: 予定作成

### 必要な情報

| 項目 | 必須 | デフォルト |
|------|------|-----------|
| summary（タイトル） | 必須 | - |
| start_time（開始日時） | 必須 | - |
| end_time（終了日時） | 任意 | 開始時刻から30分後 |
| description（説明） | 任意 | なし |
| calendar（カレンダー名） | 任意 | 私用 |

### 処理フロー

1. ユーザー入力から情報を解釈
2. 不足情報があれば**AskUserQuestion**で確認（タイトル、開始日時）
3. 解釈内容をユーザーに表示し、**確認を取ってから**実行
4. 実行結果を報告（URL付記）

### 出力形式

```
✅ YYYY-MM-DD [終日] 予定名【カレンダー名】
URL: https://www.google.com/calendar/event?eid=...
```

### 実行コマンド

```bash
mise exec --cd ~/ghq/github.com/shifumin/google-calendar-tools-ruby -- ruby google_calendar_creator.rb \
  --summary='<タイトル>' \
  --start='<開始日時:ISO8601>' \
  --end='<終了日時:ISO8601>' \
  [--description='<説明>'] \
  [--calendar='<カレンダーID>']
```

### 入力例

| 入力 | summary | start | end | calendar |
|------|---------|-------|-----|----------|
| 明日の19時から、買い物 | 買い物 | 明日19:00 | 明日19:30 | 私用 |
| 12/5 14:00-15:30 定例会議 | 定例会議 | 12/5 14:00 | 12/5 15:30 | 私用 |
| しふみん 明日10時 歯医者 | 歯医者 | 明日10:00 | 明日10:30 | しふみん |

---

## 操作3: 予定更新

### 処理フロー

1. ユーザー入力からキーワードと日付を解釈（日付指定なしは今日）
2. fetcherでイベント一覧を取得
3. キーワードで部分一致検索（大文字小文字無視）
4. マッチ結果で分岐:
   - **0件**: 該当なしを通知して終了
   - **1件**: 現在値と更新後を表示し、**確認を取ってから**実行
   - **複数件**: **AskUserQuestion**で選択させる
5. 実行結果を報告

### 更新可能項目

- summary（タイトル）
- start_time（開始日時）
- end_time（終了日時）
- description（説明）
- location（場所）

### 実行コマンド

```bash
mise exec --cd ~/ghq/github.com/shifumin/google-calendar-tools-ruby -- ruby google_calendar_updater.rb \
  --event-id='<イベントID>' \
  [--summary='<新タイトル>'] \
  [--start='<新開始日時>'] \
  [--end='<新終了日時>'] \
  [--description='<新説明>'] \
  [--location='<新場所>']
```

### 入力例

| 入力 | キーワード | 日付 | 更新内容 |
|------|-----------|------|---------|
| 会議の開始時間を14時に変更 | 会議 | 今日 | start: 14:00 |
| 明日の歯医者を15時からに変更 | 歯医者 | 明日 | start: 15:00 |
| ランチを12時から13時に変更 | ランチ | 今日 | start: 12:00, end: 13:00 |

---

## 操作4: 予定削除

### 処理フロー

1. ユーザー入力からキーワードと日付を解釈（日付指定なしは今日）
2. fetcherでイベント一覧を取得
3. キーワードで部分一致検索（大文字小文字無視）
4. マッチ結果で分岐:
   - **0件**: 該当なしを通知して終了
   - **1件**: イベント情報を表示し、**確認を取ってから**実行
   - **複数件**: **AskUserQuestion**で選択させる
5. 実行結果を報告

**重要**: 削除は取り消せないため、**必ずユーザーに確認してから**実行する。

### 実行コマンド

```bash
mise exec --cd ~/ghq/github.com/shifumin/google-calendar-tools-ruby -- ruby google_calendar_deleter.rb \
  --event-id='<イベントID>'
```

### 入力例

| 入力 | キーワード | 日付 |
|------|-----------|------|
| 歯医者を削除 | 歯医者 | 今日 |
| 明日の会議をキャンセル | 会議 | 明日 |
| 12/5の定例を消して | 定例 | 12/5 |

---

## 認証エラー時

認証トークンエラーが発生した場合、以下のコマンドの実行を案内:

```bash
mise exec --cd ~/ghq/github.com/shifumin/google-calendar-tools-ruby -- ruby google_calendar_authenticator.rb --mode=readwrite
```

---

## 技術仕様

詳細な技術仕様（JSON出力構造、スクリプト引数など）は `~/.claude/skills/google-calendar/reference.md` を参照。
