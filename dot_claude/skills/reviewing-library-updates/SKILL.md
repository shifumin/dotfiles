---
description: ライブラリアップデートPRをレビューし、マージ可否を判断する。
  「ライブラリ更新レビュー」「依存関係の更新確認」「review library update」
  「PRレビュー ライブラリ」などのリクエストで使用。
---
# Reviewing Library Updates

ライブラリアップデートPRをレビューし、セキュリティ・Breaking Changes・互換性を確認してマージ可否を判断する。

PR URLを引数で受け取る。省略時はAskUserQuestionで確認。

---

## 処理フロー

### 1. PR基本情報の取得

URL `https://github.com/<owner>/<repo>/pull/<number>` からowner/repo/numberを抽出し、並列実行:

```bash
gh pr view <PR番号> --repo <owner>/<repo> --json title,body,state,author,createdAt,url,headRefName,baseRefName
gh pr diff <PR番号> --repo <owner>/<repo>
```

diffから更新ライブラリを特定:

| 環境 | 対象ファイル |
|------|------------|
| Ruby | Gemfile.lock |
| Node.js | package.json, pnpm-lock.yaml |

各ライブラリの名前・更新前バージョン・更新後バージョンを抽出する。

### 2. 変更内容の調査

#### リポジトリの特定

| 環境 | コマンド |
|------|---------|
| Ruby | `gem info <gem名>` でHomepage URL取得 |
| Node.js | `npm info <package名> repository.url` |

URLが取得できない場合はWebSearchで検索。

#### リリースノートの確認

| 優先度 | 情報源 | 取得方法 |
|-------|--------|---------|
| 1 | GitHubリリースノート | `gh release view <version> --repo <library-repo>` |
| 2 | CHANGELOG.md | WebFetchツール |
| 3 | 公式ドキュメント | WebFetchツール |

**重要**: 更新前から更新後までの**全リリース**を確認する（中間バージョンのBreaking Changes検出のため）。

### 3. レビュー観点のチェック

#### セキュリティ修正

リリースノートで「security」「vulnerability」「CVE」を検索し、CVE番号・深刻度・概要を記録する。

#### Breaking Changes

| 影響度 | 条件 |
|-------|------|
| 高 | APIシグネチャ変更、非推奨機能削除、必須設定追加 |
| 中 | オプション設定変更、警告追加 |
| 低 | 後方互換性あり（バグ修正、パフォーマンス改善） |

#### 互換性

| 項目 | 確認内容 |
|------|---------|
| Runtime | Ruby/Node.jsバージョンの要件変更 |
| 依存関係 | 依存ライブラリのバージョン変更 |
| Framework | Rails等のフレームワーク互換性 |

### 4. プロジェクトへの影響調査

Grepツールでライブラリの使用箇所を検索する。Breaking Changes検出時は影響を受けるファイルとコード行を特定する。

| 環境 | 検索対象 |
|------|---------|
| Ruby | `*.rb` |
| Node.js | `*.ts`, `*.tsx`, `*.js` |

### 5. レビュー結果の出力

出力フォーマットに従って結果を報告する。

---

## 出力フォーマット

```markdown
### PR情報
- **タイトル**: {PRタイトル}
- **ブランチ**: {head} → {base}

### ライブラリ更新内容

| ライブラリ名 | 更新前 | 更新後 | 種別 |
|-------------|--------|--------|------|
| {名前} | {バージョン} | {バージョン} | {patch/minor/major} |

### 変更内容の要約

**{ライブラリ名} ({更新前} → {更新後})**
- {リリースノートからの主な変更点}

### セキュリティ修正: あり / なし

（ありの場合）
| CVE番号 | 深刻度 | 概要 |
|---------|--------|------|

### Breaking Changes: あり / なし

（ありの場合）
- **影響度**: 高 / 中 / 低
- **詳細**: {変更の詳細}
- **影響箇所**: {ファイルパス:行番号}
- **対応方法**: {必要な対応}

### 互換性: OK / 要確認

### 総評

**判断**: マージ可 / 条件付き / 要対応
**理由**: {条件付き/要対応の場合の理由}
```

### 判断基準

| セキュリティ修正 | Breaking Changes | 互換性 | 判断 |
|---------------|-----------------|--------|------|
| あり | - | - | マージ可（脆弱性修正を優先） |
| なし | なし | OK | マージ可 |
| なし | 高 | - | 要対応（コード修正後にマージ） |
| なし | 中 | OK | 条件付き（設定変更確認後にマージ） |
| なし | - | NG | 要対応（環境要件確認後にマージ） |
