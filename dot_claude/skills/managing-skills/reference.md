# スキル管理 技術仕様

SKILL.md から参照されるベストプラクティス詳細。

---

## 目次

1. descriptionの書き方
2. 自由度の設計指針
3. SKILL.mdテンプレート（CLI操作系）
4. SKILL.mdテンプレート（創造的タスク系）
5. reference.mdテンプレート
6. アンチパターン
7. 既存スキルの参考パターン
8. 既存スキル改善の観点
9. chezmoi固有の注意事項
10. 評価駆動開発
11. 反復開発パターン（Claude A/B）
12. 複数モデルでのテスト
13. MCPツール参照の命名規則
14. 具体例パターン（Input/Output）

---

## 1. descriptionの書き方

三人称で、「何をするか」+「いつ使うか（トリガー）」の両方を含める。Claudeはスキルを使わない方向に偏りやすいため、descriptionは積極的（"pushy"）に書く。

### 良い例

| description | 理由 |
|-------------|------|
| `Gmailのメール検索・取得・迷惑メール管理を行う。「メールを検索」「〜からのメール」「迷惑メールを削除」...ユーザーがメール、受信トレイ、Gmailに言及した場合や、メッセージの確認を必要としている場合にも使用。` | 何をするか＋トリガーが明確＋トリガー状況を積極的に列挙 |
| `フロントエンドのUI・Webページ・コンポーネントを高品質なデザインで実装する。「UIを作って」...` | 対象範囲が具体的 |

### 悪い例

| description | 問題 |
|-------------|------|
| `便利なツール` | 曖昧すぎる |
| `ドキュメントを処理する` | いつ使うかが不明 |
| `<tool>メール検索</tool>` | XMLタグ禁止 |
| `2025年1月現在のAPI仕様に基づく` | 時間依存の情報 |

### 指示の書き方: 理由を説明する

スキル本文の指示は、ルールで縛るよりも理由を説明する方が効果的。

**弱い指示（ルールのみ）:**
```
出力は必ずMarkdownテーブル形式にすること。
```

**強い指示（理由付き）:**
```
出力はMarkdownテーブル形式にする（Obsidianで即座にレンダリングされ、ソートやフィルタが可能なため）。
```

理由を理解したモデルは、想定外のケースでも適切な判断ができる。

---

## 2. 自由度の設計指針

| 自由度 | 特徴 | 記述の具体性 | 該当スキル例 |
|--------|------|-------------|-------------|
| 低 | API操作、データ変換、壊れやすい | 具体的な手順・コマンド | gmail, google-calendar |
| 中 | 半構造的タスク | 手順＋判断ポイント | github |
| 高 | 創造的タスク | 方針・原則のみ | frontend-design |

**判断基準**: 「手順を間違えたら壊れるか？」→ Yes: 低自由度、No: 高自由度

---

## 3. SKILL.mdテンプレート（CLI操作系 / 低〜中自由度）

```yaml
---
name: {skill-name}
description: {対象}の{操作}を行う。
  「{トリガー1}」「{トリガー2}」「{トリガー3}」などのリクエストで使用。
---
```

```markdown
# {スキル名}

## 操作の判定

| 操作 | トリガーとなる表現例 | 使用する手段 |
|------|---------------------|-------------|
| {操作1} | 「{表現}」 | {コマンド/ツール} |

---

## 共通設定

{パス、実行方法などの共通情報}

---

## {操作1}

### 処理フロー

1. ...
2. ...

### 実行コマンド

\`\`\`bash
{コマンド}
\`\`\`

### 出力の整形

\`\`\`markdown
{整形テンプレート}
\`\`\`

---

## エラー処理

| エラーパターン | 対処 |
|---------------|------|
| {エラー1} | {対処1} |

---

## 技術仕様

詳細は `reference.md` を参照。
```

---

## 4. SKILL.mdテンプレート（創造的タスク系 / 高自由度）

```yaml
---
name: {skill-name}
description: {対象}を{目的}。
  「{トリガー1}」「{トリガー2}」「{トリガー3}」などのリクエストで使用。
---
```

```markdown
# {スキル名}

{目的を1-2行で説明。Claudeへの期待を明記}

## 設計思考

{実装前に考えるべきポイント。箇条書きで}

## ガイドライン

{品質基準、推奨/禁止事項}

## 注意事項

{制約、避けるべきパターン}
```

---

## 5. reference.mdテンプレート

```markdown
# {スキル名}技術仕様

{SKILL.mdとの関係を1行で説明}

---

## {セクション1}

...

## {セクション2}

...
```

---

## 6. アンチパターン

| アンチパターン | 問題 | 対策 |
|---------------|------|------|
| Claudeが既知の情報を書く | context windowの無駄遣い | 差分情報のみ記載 |
| 選択肢を多数列挙 | 判断コスト増加 | 推奨を1つに絞り、代替はエスケープハッチで |
| 曖昧なスキル名 | トリガーの誤発火 | 具体的なgerund名 |
| 深いネスト参照 | 読み込み不完全のリスク | 1レベルまで |
| 時間依存の情報 | 陳腐化 | 「旧パターン」セクションで対応 |
| Windowsパス形式 | 環境依存 | UNIX形式（`/`）を使用 |
| 過度な説明 | トークン消費 | Claudeの既知情報は省略 |
| 一貫性のない用語 | 混乱 | 1概念1用語 |
| テストケースへの過適合 | 特定の例でしか動かない | 具体例からルールを一般化し、異なる説明アプローチも試す |
| 理由なきMUSTルール | モデルが意図を理解できず表面的な遵守に留まる | `ALWAYS`/`NEVER`の代わりに、なぜ重要かを説明する |

---

## 7. 既存スキルの参考パターン

| スキル | 自由度 | 構成 | 特徴 |
|--------|--------|------|------|
| gmail | 低 | SKILL.md + reference.md | CLI wrapper、JSON整形、エラー処理 |
| google-calendar | 低 | SKILL.md.tmpl + reference.md | chezmoi template、CRUD操作 |
| github | 低〜中 | SKILL.md + reference.md | `gh` CLI wrapper、簡潔 |
| frontend-design | 高 | SKILL.md のみ | 創造的指示、方針のみ |

---

## 8. 既存スキル改善の観点

既存スキルを改善する際に確認すべきポイント。

### description

| チェック項目 | 具体的に確認すること |
|-------------|-------------------|
| トリガーの網羅性 | ユーザーが使いそうな表現がカバーされているか |
| 正確性 | スキルの実際の機能と一致しているか |
| 文字数 | 1024文字以内に収まっているか |

### 処理フロー

| チェック項目 | 具体的に確認すること |
|-------------|-------------------|
| ステップの明確さ | 各ステップが具体的で迷わないか |
| 抜け漏れ | 必要な手順が欠けていないか |
| エラー処理 | 失敗時の対処が記載されているか |

### 構造

| チェック項目 | 具体的に確認すること |
|-------------|-------------------|
| セクション構成 | 論理的な順序になっているか |
| テーブル活用 | 比較・一覧情報がテーブル化されているか |
| reference.md | 技術仕様が肥大化していないか、分離すべきか |

### Claudeの挙動観察

| 観察項目 | 確認すること |
|---------|-------------|
| ファイル読み込み順序 | 想定通りの順序で参照しているか |
| 見落とし | 重要な参照ファイルを読み飛ばしていないか |
| 過剰参照 | 不要なファイルを繰り返し読んでいないか |
| 発火精度 | 意図しないリクエストで誤発火していないか |
| トランスクリプト | Extended Thinking・ツール呼び出し履歴を確認し、非効率な動作がないか |

### 一般化

| チェック項目 | 具体的に確認すること |
|-------------|-------------------|
| 過適合の回避 | 特定のテストケースだけでなく、多様なリクエストで動作するか |
| メタファーの多様性 | 同じ指示が効かない場合、別の説明アプローチを試したか |
| 理由の有無 | 重要な指示に「なぜ」が説明されているか |

---

## 9. chezmoi固有の注意事項

| 項目 | 詳細 |
|------|------|
| 編集先 | `~/.local/share/chezmoi/dot_claude/skills/{name}/` |
| ターゲット | `~/.claude/skills/{name}/` |
| テンプレート | chezmoi変数を使う場合は `.tmpl` 拡張子 |
| 適用 | `chezmoi diff` → `chezmoi apply` |
| 直接編集禁止 | `~/.claude/skills/` を直接編集しない |

---

## 10. 評価駆動開発

スキルの品質を確保するため、評価を先に設計する。

### 手順

1. **ギャップの特定**: スキルなしで代表的タスクを実行し、失敗箇所を記録
2. **評価シナリオ作成**: 最低3つのシナリオを定義
3. **ベースライン測定**: スキルなしでのパフォーマンスを確認
4. **最小限の指示を作成**: ギャップを埋める最小限のSKILL.mdを書く
5. **反復**: 評価を実行し、ベースラインと比較して改善

### 評価シナリオの構造

```json
{
  "skills": ["{skill-name}"],
  "query": "ユーザーが入力しそうなリクエスト",
  "expected_behavior": [
    "スキルが正しく発火する",
    "処理フローが期待通りに実行される",
    "出力フォーマットが正しい"
  ]
}
```

---

## 11. 反復開発パターン（Claude A/B）

2つのClaudeインスタンスを使い分けて開発する。

| 役割 | 担当 |
|------|------|
| **Claude A（設計者）** | スキルの設計・改善を行う |
| **Claude B（テスター）** | スキルを読み込んで実タスクを実行する |

### サイクル

1. Claude Aでスキルを作成/改善
2. Claude B（別セッション）で実タスクを実行
3. Claude Bの挙動を観察（失敗、見落とし、想定外の動作）
4. 観察結果をClaude Aに伝えて改善
5. 2-4を繰り返す

### 観察ポイント

- スキルが正しく発火したか
- ファイル参照の順序は想定通りか
- 不要なファイルを読み込んでいないか
- エラー時の回復が適切か

---

## 12. 複数モデルでのテスト

スキルの効果はモデルにより異なる。可能な範囲で複数モデルでテストする。

| モデル | テスト観点 |
|--------|----------|
| **Haiku**（高速・軽量） | 指示が十分に具体的か。省略しすぎていないか |
| **Sonnet**（バランス型） | 指示が明確で効率的か |
| **Opus**（高推論力） | 過剰な説明がないか。自由度を活かせているか |

**実用的なアドバイス**: Opusで完璧に動くスキルがHaikuでは指示不足になることがある。複数モデルで使う場合は、最も指示が必要なモデルに合わせる。

---

## 13. MCPツール参照の命名規則

MCPツールを使用するスキルでは、完全修飾名を使用する。

### フォーマット

```
ServerName:tool_name
```

### 例

```markdown
`BigQuery:bigquery_schema` でテーブルスキーマを取得する。
`GitHub:create_issue` でIssueを作成する。
```

**理由**: サーバー名なしだと、複数のMCPサーバーが利用可能な場合にツールが見つからないエラーが発生する。

---

## 14. 具体例パターン（Input/Output）

スキル内で出力品質を高めるために、Input/Outputペアの具体例を提供する。

### 使い方

出力フォーマットが重要なスキルでは、説明だけでなく具体例を含める:

````markdown
## コミットメッセージの生成

以下の例に従って生成:

**例1:**
Input: ユーザー認証にJWTトークンを追加
Output:
```
feat(auth): implement JWT-based authentication

Add login endpoint and token validation middleware
```

**例2:**
Input: レポートで日付が正しく表示されないバグを修正
Output:
```
fix(reports): correct date formatting in timezone conversion

Use UTC timestamps consistently across report generation
```
````

**効果**: 説明文だけよりも、具体例の方がClaudeはスタイルや詳細度を正確に理解できる。
