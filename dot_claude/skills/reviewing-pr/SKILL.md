---
description: PRをレビューし、変更内容の要約と改善点を報告する。
  「PRレビュー」「PRを見て」「review-pr」「PRをレビューして」などのリクエストで使用。
---

# Reviewing PR

PR URLを受け取り、変更内容を分析してレビュー結果を報告する。

PR URLを引数で受け取る。省略時はAskUserQuestionで確認。

---

## 処理フロー

### 1. PR情報の取得

URL `https://github.com/<owner>/<repo>/pull/<number>` からowner/repo/numberを抽出。

並列実行:

```bash
# PR基本情報
gh pr view <number> --repo <owner>/<repo> --json title,body,state,author,createdAt,url,headRefName,baseRefName

# 変更ファイル情報
gh pr view <number> --repo <owner>/<repo> --json files,additions,deletions,changedFiles

# PR diff
gh pr diff <number> --repo <owner>/<repo>
```

### 2. 変更ファイルの読み込み

以下に該当するファイルは**Readツールで全文を読み込む**:

| 条件 | 理由 |
|------|------|
| 新規追加ファイル | diffだけでは全体像が不明 |
| 変更100行以上 | diffがtruncateされる可能性 |
| diffが途中で切れている | 正確な変更把握に必要 |

**対象リポジトリのローカルパスの特定**:
1. `gh repo view <owner>/<repo> --json name -q .name` でリポジトリ名を取得
2. `~/ghq/github.com/<owner>/<repo>` にローカルクローンがあるか確認
3. ない場合は `ghq list | grep <repo>` で検索
4. 見つからない場合はdiffのみでレビュー（Readできない旨を報告）

### 3. レビュー観点チェック

#### 必須チェック（全PR）

| 観点 | チェック内容 |
|------|-------------|
| description整合性 | PRのdescriptionに書かれた意図とコード変更が一致しているか |
| ロジックの正確性 | 条件分岐、境界値、エッジケースの処理が正しいか |
| セキュリティ | SQLi、XSS、CSRF、認証漏れ、秘密情報のハードコード |
| エラーハンドリング | 異常系の考慮漏れ、握りつぶし |

#### 言語別チェック（該当時のみ）

**Ruby/Rails**:

| 観点 | チェック内容 |
|------|-------------|
| N+1問題 | ループ内でのAR呼び出し、eager load未使用 |
| scope使用 | クエリ定義は`scope`を使用しているか（クラスメソッドではなく） |
| migration | up/down整合性、インデックス適切性、不可逆変更の有無 |

**TypeScript/React**:

| 観点 | チェック内容 |
|------|-------------|
| 型安全性 | `any`の不要な使用、型アサーションの妥当性 |
| hooks | 依存配列の正確性、無限レンダリングリスク |
| a11y | セマンティックHTML、ラベル、キーボード操作 |

#### 推奨チェック

| 観点 | チェック内容 |
|------|-------------|
| SRP違反 | 1つの変更が複数の責務を持っていないか |
| パフォーマンス | 不要な再計算、非効率なクエリ、メモリリーク |
| テスト | 変更に対応するテストが追加・更新されているか |

### 4. プロジェクト固有ルールの確認

対象リポジトリのローカルクローンが存在する場合:

1. `CLAUDE.md`をReadで確認し、プロジェクト固有のコーディング規約・レビュー観点を把握
2. 該当するルールがあればレビュー観点に追加

---

## 出力フォーマット

```markdown
## PR情報
- **タイトル**: {タイトル}
- **作成者**: @{author}
- **状態**: {OPEN/MERGED/CLOSED}
- **ブランチ**: {head} → {base}

## やりたいこと / やったこと
{descriptionから抽出した要約}

## 変更内容のまとめ
### `{path/to/file}`
**変更行**: L{start}-L{end}
**変更概要**: {概要}

## 良い点
- {実装の優れている点}

## 修正が必要な点
### 1. {問題の概要}
**ファイル**: `{path/to/file}:{line}`
**問題点**: {影響の説明}
**修正案**:
```{lang}
{コード}
```

## description整合性
✅ 整合性あり / ⚠️ 差異あり（詳細）

## チェック実施状況
- [x] description整合性
- [x] ロジック正確性
- [x] セキュリティ
- [ ] N+1問題（該当なし）

## 総評
{全体の評価}
**承認推奨**: ✅ 承認可 / ⚠️ 条件付き / ❌ 要修正
```

**出力ルール**:

| ルール | 詳細 |
|--------|------|
| 問題なし項目 | 「修正が必要な点」に記載しない |
| 行番号 | Readツールで確認した正確な行番号のみ記載 |
| コードパス | リポジトリルートからの相対パスを使用 |
| 言語別チェック | 該当言語がない場合はスキップ |

---

## エラー処理

| エラーパターン | 対処 |
|---------------|------|
| PR番号・リポジトリが不正 | URLの形式を確認し、ユーザーに再入力を依頼 |
| アクセス権なし（HTTP 404） | `gh auth status`で認証確認を案内 |
| ローカルクローンなし | diffのみでレビュー。Readできなかった旨を報告 |
| diffがtruncate | `gh api`で個別ファイルのdiffを取得 |

---

## 他スキルとの使い分け

| 操作 | 使用先 |
|------|--------|
| PRの全体レビュー | **このスキル** |
| レビューコメントへの対応 | `/reviewing-pr-comments` |
| PR/Issue情報取得・作成 | `/github` |
| commit + push | `/push` |
