# review-library-update [PR URL]

引数で渡されたライブラリアップデートのPRをレビューし、マージして問題ないかを確認します。

---

## 実行フロー

### STEP 1: PR URLのパースと基本情報の取得

#### 1-1. URLから情報を抽出

**URL形式**: `https://github.com/<オーナー>/<リポジトリ>/pull/<PR番号>`

**抽出方法**:
- 正規表現パターン: `github\.com/([^/]+)/([^/]+)/pull/(\d+)`
- 抽出例: `https://github.com/your-org/your-repo/pull/12345`
  - オーナー/リポジトリ: `your-org/your-repo`
  - PR番号: `12345`

#### 1-2. PR情報の取得（並列実行）

以下のコマンドを**並列実行**してPR情報を取得：

```bash
# 基本情報
gh pr view <PR番号> --repo <オーナー>/<リポジトリ> --json title,body,state,author,createdAt,url,headRefName,baseRefName

# 差分（更新されるライブラリを特定するため）
gh pr diff <PR番号> --repo <オーナー>/<リポジトリ>
```

#### 1-3. 更新されるライブラリの特定

diffから以下の情報を抽出：

**Rubyの場合（Gemfile.lock）**:
- 更新前のバージョン
- 更新後のバージョン
- ライブラリ名

**Node.jsの場合（package.json, pnpm-lock.yaml等）**:
- 更新前のバージョン
- 更新後のバージョン
- パッケージ名

---

### STEP 2: ライブラリの変更内容の調査

#### 2-1. GitHubリリースページの確認

**リポジトリの特定**:
- Rubyの場合: RubyGemsまたはGitHubで検索
- Node.jsの場合: npmまたはGitHubで検索

**確認方法**:
```bash
# ライブラリのGitHubリポジトリを特定してリリース情報を取得
gh release list --repo <ライブラリのリポジトリ> --limit 20
gh release view <バージョン> --repo <ライブラリのリポジトリ>
```

#### 2-2. CHANGELOGの確認

以下の優先順位で確認：

1. **GitHubリリースノート**: `gh release view`で取得
2. **CHANGELOG.md**: WebFetchツールでリポジトリのCHANGELOG.mdを取得
3. **公式ドキュメント**: 必要に応じてWebFetchで確認

#### 2-3. 確認すべきバージョン範囲

更新前バージョンから更新後バージョンまでの**全てのリリース**を確認する

**例**: `1.2.0` → `1.5.0` の場合
- v1.3.0, v1.4.0, v1.5.0 の全てのリリースノートを確認

---

### STEP 3: レビュー観点のチェック

#### 3-1. Breaking Changes（破壊的変更）の確認

**チェックポイント**:
- ❌ APIの変更（メソッド名、引数、戻り値の変更）
- ❌ 非推奨機能の削除
- ❌ デフォルト動作の変更
- ❌ 必須の設定変更

**影響度の評価**:
- 🔴 **高**: コード修正が必須
- 🟡 **中**: 設定変更や軽微な修正が必要
- 🟢 **低**: 互換性あり

#### 3-2. セキュリティ修正の確認

**チェックポイント**:
- CVE番号が付与されている脆弱性の修正
- セキュリティアドバイザリの有無
- 修正された脆弱性の深刻度（CVSS等）

**確認方法**:
- リリースノートで「security」「vulnerability」「CVE」を検索
- GitHubのSecurity Advisoriesを確認

#### 3-3. 互換性の確認

**チェックポイント**:
- Ruby/Node.jsバージョンの要件変更
- 依存ライブラリのバージョン変更
- フレームワーク（Rails等）との互換性

#### 3-4. 新機能・改善点の確認

**チェックポイント**:
- 有用な新機能の追加
- パフォーマンス改善
- バグ修正

---

### STEP 4: プロジェクトへの影響調査

#### 4-1. 使用箇所の確認

更新されるライブラリがプロジェクト内でどのように使用されているかを確認：

```bash
# Rubyライブラリの場合
grep -r "<ライブラリ名>" --include="*.rb" .

# Node.jsパッケージの場合
grep -r "<パッケージ名>" --include="*.ts" --include="*.tsx" --include="*.js" .
```

#### 4-2. Breaking Changesの影響範囲

Breaking Changesが検出された場合、プロジェクト内の該当コードを特定

---

### STEP 5: レビュー結果の出力

---

## 出力フォーマット

### PR情報

- **タイトル**: [PRタイトル]
- **作成者**: [作成者名（Dependabot等）]
- **状態**: [OPEN/MERGED/CLOSED]
- **ブランチ**: [headブランチ] → [baseブランチ]

---

### ライブラリ更新内容

| ライブラリ名 | 更新前 | 更新後 | 種別 |
|-------------|--------|--------|------|
| [名前] | [バージョン] | [バージョン] | [patch/minor/major] |

---

### 変更内容の要約

#### [ライブラリ名] ([更新前] → [更新後])

**主な変更点**:
- [リリースノートから抽出した主要な変更点を箇条書き]

---

### 🔒 セキュリティ修正

**検出**: ✅ あり / ❌ なし

[ありの場合]
| CVE番号 | 深刻度 | 概要 |
|---------|--------|------|
| [CVE-XXXX-XXXXX] | [Critical/High/Medium/Low] | [概要] |

---

### ⚠️ Breaking Changes（破壊的変更）

**検出**: ✅ あり / ❌ なし

[ありの場合]
#### [変更内容]
- **影響度**: 🔴 高 / 🟡 中 / 🟢 低
- **詳細**: [変更の詳細]
- **対応方法**: [必要な対応がある場合]

---

### 🔄 互換性

**Ruby/Node.jsバージョン**: ✅ 互換性あり / ⚠️ 要確認
**依存ライブラリ**: ✅ 問題なし / ⚠️ 要確認
**フレームワーク互換性**: ✅ 問題なし / ⚠️ 要確認

---

### 📦 プロジェクトへの影響

**使用箇所**: [N箇所]

[Breaking Changesがある場合]
**影響を受けるファイル**:
- `path/to/file.rb:123`
- ...

---

### 総評

[全体的な評価]

**マージ推奨**: ✅ マージ可 / ⚠️ 条件付きマージ可 / ❌ 要対応

[条件付き/要対応の場合の理由]

---

## 注意事項

- セキュリティ修正を含む更新は優先的にマージを推奨
- Breaking Changesがある場合は、対応方法を確認してからマージ
- majorバージョンアップの場合は特に慎重に確認

---

## 使用例

```bash
/review-library-update https://github.com/your-org/your-repo/pull/12345
```
