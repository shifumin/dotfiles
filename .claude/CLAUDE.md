# CLAUDE.md

このドキュメントは、Claude Codeを使用する際の必須ガイドラインです。以下の指示に必ず従ってください。

## 🚨 重要な原則

1. **既存のコードスタイルを厳守する** - プロジェクトの規約から逸脱しない
2. **プロジェクトのツールを使用する** - 新しいツールやフレームワークを勝手に導入しない
3. **コミット前の必須チェック** - リンターとテストを必ず実行する
4. **テストの同期** - 実装を追加・変更した場合は、対応するテストも必ず追加・変更する
5. **ドキュメントの更新** - 必要に応じてREADME.mdとCLAUDE.mdを更新する
   - **README.mdは英語で記述する** - プロジェクトの国際的な利用を考慮し、README.mdは英語で書く
6. **CLAUDE.mdへの記載形式** - CLAUDE.mdに内容を追加する際は、Claude Codeが理解しやすい明確で構造化された形式で記載する
7. **要件や仕様に疑問があれば必ず立ち止まって質問する** - 実装方法や要件・仕様に疑問が生じた場合は、必ず作業を中断してユーザーに確認する

## 💡 コード品質ガイドライン

### クリーンコードの原則
- **変数名・関数名は意図を明確に** - 読み手が推測せずに理解できる名前を使用する
- **関数・メソッドは単一責任の原則（Single Responsibility Principle）に則る** - 1つの関数は1つの責任のみを持つ
- **複雑なロジックには説明を追加する** - コメントやドキュメンテーションで意図を明確にする
- **必要な場合は早期returnを利用する** - ネストを深くせず、読みやすいコードを心がける
- **エラーメッセージは明確にする** - 何が問題で、どう解決すべきかを示す
- **マジックナンバーは避ける** - 定数や設定値として意味のある名前を付ける

### エラーハンドリング
- **明確なエラーメッセージ** - 問題の内容と解決方法を含める
- **適切な例外の使用** - 状況に応じた適切な例外クラスを選択
- **エラー処理の一貫性** - プロジェクト全体で統一されたエラーハンドリングパターンを使用
- **ユーザーフレンドリーなメッセージ** - 技術的すぎない、理解しやすいメッセージを提供

### 単一責任の原則の確認とリファクタリング
1. **コード全体を確認** - 実装コードが単一責任の原則を満たしているか確認
2. **メソッド・関数単位で検証** - 各メソッド・関数が1つの責任のみを持つか確認
3. **違反箇所のリストアップ** - 原則に違反している箇所を特定
4. **段階的なリファクタリング** - 違反箇所を1つずつ適切に分割・整理

### 既存コードの尊重
- プロジェクトの命名規則に従う
- 既存のコードパターンを踏襲する
- プロジェクト固有の設定ファイル（.rubocop.yml、.eslintrc等）に従う
- **メソッドの可視性を適切に設定** - public/private/protectedを意図的に使い分ける
- **publicインターフェースの明確化** - ヘルパーメソッドはprivateにし、必要最小限のpublicメソッドのみを公開

### ファイル命名規則
- **無効な文字の処理** - ファイル名に使用できない文字（`/`, `:`, `*`, `?`, `"`, `<`, `>`, `|`）は `_` に置換
- **意味のある命名** - ファイルの内容が推測できる名前を使用
- **一貫性のある形式** - プロジェクト全体で統一された命名パターンを維持

### テスト作成の原則
- **必要十分なテストを作成** - 過剰なテストは避け、本質的なケースをカバーする
- **実装ファイルごとに網羅的に確認** - 各実装ファイルに対応するテストの存在を確認
- **正常系・異常系・エッジケースを網羅** - 期待される動作だけでなく、例外処理やエッジケースもテスト
- **publicインターフェースのみテスト** - privateメソッドの直接テストは禁止
- **テスト実行の確認** - テストを追加・変更した場合は必ず全テストが通ることを確認
- **テストユーティリティの特例** - テストサポートファイルは複雑なセットアップが必要な場合、メトリクス制約を緩和可能
- **テストカバレッジの要件**:
  - すべてのpublicメソッドは包括的なテストカバレッジが必須
  - ユーザー向けのエラーはすべてテストする
  - 統合テストは完全なワークフローをカバーする
  - ユニットテストは1つのことに集中する
  - 重複するテストは統合して保守性を向上させる

## 🔄 標準ワークフロー

### 1. 作業開始前のチェックリスト
- [ ] README.mdを読んだか？
- [ ] 既存のコードパターンを理解したか？
- [ ] 使用可能なツールとコマンドを確認したか？
- [ ] テストの実行方法を確認したか？

```bash
# 現在の状態を確認
git status
git diff

# テストが通ることを確認
# [プロジェクトのテストコマンド]
# 例: rspec, npm test, pytest, go test 等
```

### 2. 実装中の注意点
- 既存パターンに従う
- エラーハンドリングを実装
- テストを同時に作成・更新
- **実装変更後は必ずテストを実行** - 変更した機能に関連するテストが通ることを確認

### 3. 作業完了前の必須チェック
```bash
# リンター実行
# [プロジェクトのリンターコマンド]

# テスト実行
# [プロジェクトのテストコマンド]

# 変更内容の確認
git diff
```

### 4. コミット・プッシュ前の秘匿情報確認
**重要**: コミット・プッシュする前に、以下の秘匿情報や個人情報が含まれていないか必ず確認する
- **APIキー・トークン** - AWSアクセスキー、GitHubトークン、OAuth認証情報等
- **パスワード・認証情報** - データベースパスワード、管理者パスワード等
- **個人情報** - メールアドレス、電話番号、住所、氏名等（公開を意図しない場合）
- **内部URL・エンドポイント** - 社内システムのURL、プライベートなAPIエンドポイント等
- **秘密鍵・証明書** - SSHキー、SSL証明書、暗号化キー等
- **環境固有の設定** - 本番環境の接続情報、内部IPアドレス等

**確認手順**:
1. `git diff --staged`で変更内容を詳細に確認
2. 秘匿情報が含まれている場合は、即座にユーザーに報告
3. 必要に応じて`.gitignore`に追加して除外
4. 既にコミットしてしまった場合は、履歴から完全に削除する必要があることを伝える

## 🛠️ 言語別コマンドリファレンス

### 共通原則
- プロジェクトで使用されているツールを確認する（package.json、Gemfile、requirements.txt等）
- 既存のスクリプトやコマンドを優先的に使用する
- プロジェクト固有の設定ファイルに従う

### Ruby
```bash
# リンター実行（コミット前に必須）
rubocop
rubocop -a  # 自動修正

# テスト実行（コミット前に必須）
rspec  # または bundle exec rspec
rspec spec/path/to/spec_file.rb  # 特定ファイル
rspec spec/path/to/spec_file.rb:42  # 特定行

# バージョン管理
# .ruby-versionファイルでRubyバージョンを指定
# Gemfileで ruby File.read('.ruby-version').strip を使用
```

### JavaScript/TypeScript
```bash
npm run lint  # リンター実行
npm test  # テスト実行
```

### Python
```bash
ruff check  # リンター実行
pytest  # テスト実行
```

### Go
```bash
go fmt  # フォーマッター実行
go test  # テスト実行
```

### Java
```bash
mvn checkstyle:check  # リンター実行
mvn test  # テスト実行
```

## ⚠️ 絶対に避けるべきこと

- ❌ テストなしで実装をコミットする
- ❌ リンターエラーを無視する
- ❌ 既存の命名規則から逸脱する
- ❌ 秘匿情報をコードやコミットに含める（詳細は「コミット・プッシュ前の秘匿情報確認」セクションを参照）

## 💪 パフォーマンス考慮事項

### 効率的な処理
- **ストリーミング/チャンク処理** - 大きなファイルは部分的に処理
- **必要最小限のメモリ使用** - 必要なデータのみメモリに保持
- **効率的なアルゴリズム** - 時間計算量とメモリ使用量を考慮
- **遅延評価** - 必要になるまで処理を遅延させる
- **キャッシュの活用** - 繰り返し使用されるデータは適切にキャッシュ

## 🔧 トラブルシューティング

### 一般的なデバッグのヒント
1. **verbose/debugフラグを活用** - 詳細な処理情報を確認
2. **dry-runオプションを使用** - 実際の実行前に変更内容をプレビュー
3. **verboseとdry-runの組み合わせ** - 実行フロー全体を理解
4. **ログファイルやエラー出力を確認** - 具体的なエラーメッセージを特定
5. **エンコーディング問題** - デバッガーで生データを確認

### テスト失敗時
```bash
# 特定のテストのみ実行して原因を特定
# [プロジェクトのテストコマンド] [失敗したテストファイル] [オプション]

# Ruby例:
rspec spec/failing_spec.rb -fd
rspec --only-failures
```

### リンターエラー時
```bash
# 自動修正を試みる
# [プロジェクトのリンターコマンド] [自動修正オプション]

# Ruby例:
rubocop -a
rubocop path/to/file.rb
```

### 依存関係エラー時
```bash
# 依存関係をインストール
# [プロジェクトのパッケージマネージャー] install

# Ruby例:
bundle install
bundle update gem_name
```

## 🛡️ Claude Codeカスタムコマンド

~/.claude/commands/に以下のカスタムコマンドが定義されています：

- **check-srp** - 単一責任の原則（SRP）を満たしているか確認
  - 実装コードのSRP違反をチェック
  - 必要に応じてリファクタリング
- **finish** - 仕上げの作業をまとめたもの
  - リンターとテストを実行
  - 必要に応じてドキュメントを更新
- **gemini-search** - Google Gemini CLIを使用したWeb検索
  - 組み込みのWeb_Searchツールの代わりに使用
  - `gemini --prompt "WebSearch: <query>"`で実行
- **push** - 変更内容を適切な粒度でcommit/push
  - 変更内容を確認して適切にコミット
  - コミットメッセージは変更内容を正確に反映
- **rubocop** - Rubyのリンター実行
- **update-claude-md** - 指定内容でCLAUDE.mdを更新
  - 内容を理解しやすい形式に整理して追加
- **update-test** - テストを必要十分な状態にする
  - 既存テストの過不足を確認し、適切に調整
  - 実装ファイルごとにテストの存在を確認
- **update-document** - ドキュメント（CLAUDE.md/README.md）を更新
  - 重複内容の整理と必要情報の追加
- **notebooklm-upload** - NotebookLMにファイルをアップロードして音声概要を作成
  - Playwright MCPを使用してNotebookLMにファイルをアップロード
  - 音声概要（ポッドキャスト形式）の生成を自動化
- **chatgpt-o3-search** - ChatGPT O3モデルでWeb検索を実行
  - Playwright MCPを使用してChatGPT O3モデルでプロンプトを実行
  - Web検索機能を有効にして最新情報を取得
  - **重要**: O3の回答は要約せずオリジナルのまま出力
- **gemini-25pro-search** - Gemini 2.5 ProモデルでWeb検索を実行
  - Playwright MCPを使用してGemini 2.5 Proでプロンプトを実行
  - **重要**: Geminiの回答は要約せずオリジナルのまま出力
- **claude-opus4-search** - Claude Opus 4モデルでWeb検索を実行
  - Playwright MCPを使用してClaude Opus 4でプロンプトを実行
  - Web検索機能を有効にして最新情報を取得
  - **重要**: Claudeの回答は要約せずオリジナルのまま出力
- **multi-llm-search** - 3つのLLMで同時にWeb検索を実行
  - ChatGPT O3、Claude Opus 4、Gemini 2.5 Proで同じプロンプトを実行
  - 各LLMのWeb検索機能を有効化
  - **重要**: 全てのLLMの回答を要約せずオリジナルのまま出力

## 📝 プロジェクト固有の設定

プロジェクト固有の追加情報がある場合は、以下に記載してください：

---

**注意**: このドキュメントの指示は、デフォルトの動作よりも優先されます。必ず従ってください。